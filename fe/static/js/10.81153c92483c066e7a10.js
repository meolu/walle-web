webpackJsonp([10],{A3Eg:function(e,r){},Pi2Z:function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var a=t("//Fk"),s=t.n(a),n=t("Dd8w"),o=t.n(n),c=t("Xxa5"),i=t.n(c),u=t("exGp"),m=t.n(u),l=t("oZit"),f=t("4kd1"),d=t("diZN");function p(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(d.b)("repo/branches/",e,r)}function v(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(d.b)("repo/tags/",e,r)}function h(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object(d.b)("repo/commits/",e,r)}var b={props:{taskId:String,space:{type:String,required:!0}},created:function(){var e=this;return m()(i.a.mark(function r(){return i.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(!e.isNew){r.next=4;break}e.getProject(e.$route.params.projectId),r.next=7;break;case 4:return r.next=6,e.getTask();case 6:e.getProject();case 7:case"end":return r.stop()}},r,e)}))()},data:function(){return{breadcrumbData:[{to:"/"+this.space+"/deploy/index",name:"上线单"},{to:"",name:this.id?"编辑":"创建"}],project:{},task:{},branchs:[],tags:[],commits:[],form:{name:"",branch:"",commit_id:"",servers_mode:"全量服务器上线",servers:[],tag:""},rules:{name:[{required:!0,message:"请输入上线单名称",trigger:"blur"}]}}},computed:{isNew:function(){return"TaskCreateOfProject"===this.$route.name&&!this.taskId}},methods:{checkServers:function(){return this.project.servers_info.length===this.task.servers_info.length?"全量服务器上线":"自定义服务器上线"},getProject:function(e){var r=this;return m()(i.a.mark(function t(){var a,s,n,o,c,u;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Object(l.c)(e||r.task.project_id);case 2:if(a=t.sent,s=a.data,r.project=s,r.isNew?r.form.servers=[].concat(r.project.servers_info):r.form.servers=r.task.servers_info,r.isNew||(r.form.servers_mode=r.checkServers()),"branch"!==r.project.repo_mode){t.next=15;break}return t.next=10,p({project_id:r.project.id});case 10:n=t.sent,o=n.data.branches,r.branchs=o,t.next=20;break;case 15:return t.next=17,v({project_id:r.project.id});case 17:c=t.sent,u=c.data.tags,r.tags=u;case 20:case"end":return t.stop()}},t,r)}))()},getTask:function(){var e=this;return m()(i.a.mark(function r(){var t,a;return i.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,Object(f.d)(e.$route.params.taskId);case 3:return t=r.sent,a=t.data,e.task=a,e.form=o()({},e.form,a),r.abrupt("return",s.a.resolve());case 10:return r.prev=10,r.t0=r.catch(0),r.abrupt("return",s.a.reject(r.t0));case 13:case"end":return r.stop()}},r,e,[[0,10]])}))()},requertForm:function(){return{name:this.form.name,project_id:this.project.id,servers:this.form.servers.map(function(e){return e.id}).join(","),commit_id:this.form.commit_id,branch:this.form.branch,file_transmission_mode:0,file_list:"*.log",tag:this.form.tag}},onSubmit:function(){var e=this;this.$refs.form.validate(function(r){if(!r)return!1;e.isNew?e.addTask():e.updateTask()})},addTask:function(){var e=this;return m()(i.a.mark(function r(){return i.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,Object(f.a)(e.requertForm());case 2:e.$message({type:"success",message:"添加成功"}),e.$router.push("/"+e.space+"/deploy/index");case 4:case"end":return r.stop()}},r,e)}))()},updateTask:function(){var e=this;return m()(i.a.mark(function r(){return i.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,Object(f.g)(e.$route.params.taskId,e.requertForm());case 2:e.$message({type:"success",message:"修改成功"}),e.$router.push("/"+e.space+"/deploy/index");case 4:case"end":return r.stop()}},r,e)}))()},deleteServer:function(e,r){this.form.servers.splice(r,1)}},watch:{"form.servers_mode":{immediate:!0,handler:function(e){"全量服务器上线"===e&&(this.form.servers=this.project&&this.project.servers_info?[].concat(this.project.servers_info):[])}},"form.branch":{handler:function(e){var r=this;return m()(i.a.mark(function t(){var a,s;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,h({project_id:r.project.id,branch:e});case 2:a=t.sent,s=a.data.branches,r.commits=s;case 5:case"end":return t.stop()}},t,r)}))()}}}},_={render:function(){var e=this,r=e.$createElement,t=e._self._c||r;return t("div",{staticClass:"wl-task-edit"},[t("wl-breadcrumb",{attrs:{data:e.breadcrumbData}}),e._v(" "),t("div",{staticClass:"wl-task-edit__content"},[t("el-form",{ref:"form",attrs:{model:e.form,"label-width":"100px",rules:e.rules,size:"small"}},[t("el-form-item",{attrs:{label:"上线单标题",prop:"name"}},[t("el-input",{model:{value:e.form.name,callback:function(r){e.$set(e.form,"name",r)},expression:"form.name"}})],1),e._v(" "),e.project&&"branch"===e.project.repo_mode?t("el-form-item",{attrs:{label:"选取分支"}},[t("el-select",{attrs:{placeholder:"选取分支"},model:{value:e.form.branch,callback:function(r){e.$set(e.form,"branch",r)},expression:"form.branch"}},e._l(e.branchs,function(e){return t("el-option",{key:e,attrs:{label:e,value:e}})}))],1):e._e(),e._v(" "),e.project&&"tag"===e.project.repo_mode?t("el-form-item",{attrs:{label:"选取Tag"}},[t("el-select",{attrs:{placeholder:"选取Tag"},model:{value:e.form.tag,callback:function(r){e.$set(e.form,"tag",r)},expression:"form.tag"}},e._l(e.tags,function(e){return t("el-option",{key:e,attrs:{label:e,value:e}})}))],1):e._e(),e._v(" "),e.project&&"branch"===e.project.repo_mode?t("el-form-item",{attrs:{label:"选取版本"}},[t("el-select",{attrs:{placeholder:"选取版本"},model:{value:e.form.commit_id,callback:function(r){e.$set(e.form,"commit_id",r)},expression:"form.commit_id"}},e._l(e.commits,function(e){return t("el-option",{key:e.id,attrs:{label:e.name,value:e.id}})}))],1):e._e(),e._v(" "),t("el-form-item",{attrs:{label:"选取服务器"}},[t("el-radio-group",{model:{value:e.form.servers_mode,callback:function(r){e.$set(e.form,"servers_mode",r)},expression:"form.servers_mode"}},[t("el-radio",{attrs:{label:"全量服务器上线"}}),e._v(" "),t("el-radio",{attrs:{label:"自定义服务器上线"}})],1)],1),e._v(" "),"自定义服务器上线"===e.form.servers_mode?t("el-form-item",[t("div",{staticClass:"wl-task-edit__servers"},e._l(e.form.servers,function(r,a){return t("el-tag",{key:r.id,attrs:{closable:"",type:"info"},on:{close:function(){return e.deleteServer(r,a)}}},[e._v("\n                    "+e._s(r.name)+"\n                  ")])}))]):e._e(),e._v(" "),t("el-form-item",[t("el-button",{attrs:{type:"primary"},on:{click:e.onSubmit}},[e._v("提交")])],1)],1)],1)],1)},staticRenderFns:[]};var k=t("VU/8")(b,_,!1,function(e){t("A3Eg")},null,null);r.default=k.exports}});